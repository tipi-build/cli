name: check_install_script
on:
  push:
    branches:
      - master
  pull_request:
  schedule:
    - cron : '0 0 * * *' # Every midnight check the released version of default branch
  

jobs:
  install-macos:
    name: install-macos
    runs-on: macos-latest
    steps:
      - name: test_install_on_macos
        run: |
          if [ $GITHUB_EVENT_NAME = "pull_request" ]; then
            script_source=${GITHUB_HEAD_REF}
          else 
            script_source=${GITHUB_REF#refs/heads/}
          fi
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/tipi-build/cli/${script_source}/install/install_for_macos_linux.sh)"

          # Test install succeeeded 
          test -f /usr/local/bin/tipi
          test -f ~/.tipi/clang/bc504cefc97234ddace75a90b20337205fe76ad7/bin/clang
          test -f ~/.tipi/cmake/c7aeea101063fe54911519fae5427096ed557398/bin/cmake
          test -f ~/.tipi/emsdk/f693e7f511d2d320d20a1376812321763027728e/emsdk
          test -f ~/.tipi/environments/690be18d90ea5d264c93cea5a372dcaab64fd33d/xcode.cmake
          test -f ~/.tipi/go/1e2561d8307eb513a23eb7c9a8b769b800db27af/bin/go
          test -f ~/.tipi/jdk/399c189d3145c6f3d7ab8e829bfd0d61eb30a3c5/Contents/Home/bin/jar
          test -f ~/.tipi/nodejs/71c4c7ceddafd46143832abc136c592192c70713/bin/node
          test -f ~/.tipi/openapi/ec7cbaed034d7aaeb2a0f22619a8927c08a74894/openapi-generator-cli-5.1.1.jar
          test -f ~/.tipi/openapi-generator-script/4fc850d4a145be49a9aa0428dcbc5c5c82f19f93/openapi-generator-cli
          test -f ~/.tipi/platform/2a344bab73de81f19feca4fa3d724e1d9607d55e/cmake/projects/Poco/hunter.cmake
          test -f ~/.tipi/python/54b633011cd24867662c9dbaeda596bb3261a09c/bin/python
          test -f ~/.tipi/file-sync/d20a8c574b546801f0964780e612adb69e1f84d4/pysearpc/client.py

  install-linux:
    name: install-linux
    runs-on: ubuntu-latest
    steps:
      - name: test_install_on_linux
        run: |
          if [ $GITHUB_EVENT_NAME = "pull_request" ]; then
            script_source=${GITHUB_HEAD_REF}
          else 
            script_source=${GITHUB_REF#refs/heads/}
          fi
          echo "Script source : ${script_source}"
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/tipi-build/cli/${script_source}/install/install_for_macos_linux.sh)"
          
          # Test install succeeeded 
          echo "verif tipi"
          test -f /usr/local/bin/tipi
          test -f ~/.tipi/clang/4d913c12c6ea26b34ad250f7860cabf4320783f2/bin/clang
          test -f ~/.tipi/cmake/7e4b5225c96db5a135c034b4220925c87b4f9a5f/bin/cmake
          test -f ~/.tipi/emsdk/f693e7f511d2d320d20a1376812321763027728e/emsdk
          test -f ~/.tipi/environments/690be18d90ea5d264c93cea5a372dcaab64fd33d/xcode.cmake
          test -f ~/.tipi/go/9fc8f520528b3f353b1feeb1279f241d2a5c3677/bin/go
          test -f ~/.tipi/jdk/1946904e4d5ad74f3193d07d7c8a98136dbaff74/bin/jar
          test -f ~/.tipi/nodejs/4472af28a2bd943fe64f4dfb9d44c5ebde152ec0/bin/node
          test -f ~/.tipi/openapi/ec7cbaed034d7aaeb2a0f22619a8927c08a74894/openapi-generator-cli-5.1.1.jar
          test -f ~/.tipi/openapi-generator-script/4fc850d4a145be49a9aa0428dcbc5c5c82f19f93/openapi-generator-cli
          test -f ~/.tipi/file-sync/9b0a5c87058b68cd466a3cc8e8cfd7d9cbd89df2/pysearpc/client.py
          test -f ~/.tipi/platform/2a344bab73de81f19feca4fa3d724e1d9607d55e/cmake/projects/Poco/hunter.cmake

  install-windows-powershell:
    name: install-windows-powershell
    runs-on: windows-latest
    steps:
      - name: test_install_on_windows_powershell
        run: |
          if ($env:GITHUB_EVENT_NAME -eq "pull_request") {
            $script_source = $env:GITHUB_HEAD_REF.replace('refs/heads/', '')
          } else {
            $script_source = $env:GITHUB_REF.replace('refs/heads/', '')
          }
          . { iwr -useb https://raw.githubusercontent.com/tipi-build/cli/$script_source/install/install_for_windows.ps1 } | iex 
          if (!($?)) {exit 1}
          # Test install succeeeded 
          if (!(Test-Path "C:\\ProgramData\\tipi\\tipi.exe" -PathType leaf)) { exit 1; }
          if (!(Test-Path "C:\\.tipi\\clang\\4ee08f2e332b2080663072d5a6ce0200508a83e4\\bin\\clang.exe" -PathType leaf)) { exit 1; }
          if (!(Test-Path "C:\\.tipi\\cmake\\51e611bb39f8f4c49a160085048e0dd24ec22812\\bin\\cmake.exe" -PathType leaf)) { exit 1; }
          if (!(Test-Path "C:\\.tipi\\emsdk\\f693e7f511d2d320d20a1376812321763027728e\\emsdk.bat" -PathType leaf)) { exit 1; }
          if (!(Test-Path "C:\\.tipi\\environments\\690be18d90ea5d264c93cea5a372dcaab64fd33d\\xcode.cmake" -PathType leaf)) { exit 1; }
          if (!(Test-Path "C:\\.tipi\\go\\782c595c1aece9fea8bfa7a14bfbf52e206a0f91\\bin\\go.exe" -PathType leaf)) { exit 1; }
          if (!(Test-Path "C:\\.tipi\\jdk\\112dbf189260a647842e98671516f18e4de070f9\\bin\\jar.exe" -PathType leaf)) { exit 1; }
          if (!(Test-Path "C:\\.tipi\\nodejs\\ec44ef72df91ffc4b02df49e75c46b8f845fab5e\\node.exe" -PathType leaf)) { exit 1; }
          if (!(Test-Path "C:\\.tipi\\openapi\\ec7cbaed034d7aaeb2a0f22619a8927c08a74894\\openapi-generator-cli-5.1.1.jar" -PathType leaf)) { exit 1; }
          if (!(Test-Path "C:\\.tipi\\openapi-generator-script\\4fc850d4a145be49a9aa0428dcbc5c5c82f19f93\\openapi-generator-cli.bat" -PathType leaf)) { exit 1; }
          if (!(Test-Path "C:\\.tipi\\openssh\\0a60a7d9d6ac67dfe4b97f720ad780dd185ed432\\ssh.exe" -PathType leaf)) { exit 1; }
          if (!(Test-Path "C:\\.tipi\\perl\\ac3ce102081ac6f9b3b43d81c30ac77b08493eff\\README.txt" -PathType leaf)) { exit 1; }
          if (!(Test-Path "C:\\.tipi\\platform\\2a344bab73de81f19feca4fa3d724e1d9607d55e\\cmake\\projects\\Poco\\hunter.cmake" -PathType leaf)) { exit 1; }
          if (!(Test-Path "C:\\.tipi\\python\\30314b4574f1f162767a6a66a64410b9a9e2829d\\python.exe" -PathType leaf)) { exit 1; }
          if (!(Test-Path "C:\\.tipi\\file-sync\\01b125c46bed19ec725984b91aa8ac096ec3c7f2\\pysearpc\\client.py" -PathType leaf)) { exit 1; }
        shell: powershell 

  install-archlinux:
    name: install-archlinux
    runs-on: ubuntu-latest
    env:
      GITHUB_EVENT_NAME: $GITHUB_EVENT_NAME
      GITHUB_HEAD_REF: $GITHUB_HEAD_REF
      GITHUB_REF: $GITHUB_REF
    container: 
      image: archlinux
    steps:
      - name: test_install_on_linux
        run: |
          if [ $GITHUB_EVENT_NAME = "pull_request" ]; then
            script_source=${GITHUB_HEAD_REF}
          else 
            script_source=${GITHUB_REF#refs/heads/}
          fi
          echo "Script source : ${script_source}"
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/tipi-build/cli/${script_source}/install/install_for_macos_linux.sh)"
          # Test install succeeeded 
          echo "verif tipi"
          test -f /usr/local/bin/tipi
          test -f ~/.tipi/clang/4d913c12c6ea26b34ad250f7860cabf4320783f2/bin/clang
          test -f ~/.tipi/cmake/7e4b5225c96db5a135c034b4220925c87b4f9a5f/bin/cmake
          test -f ~/.tipi/emsdk/f693e7f511d2d320d20a1376812321763027728e/emsdk
          test -f ~/.tipi/environments/690be18d90ea5d264c93cea5a372dcaab64fd33d/xcode.cmake
          test -f ~/.tipi/go/9fc8f520528b3f353b1feeb1279f241d2a5c3677/bin/go
          test -f ~/.tipi/jdk/1946904e4d5ad74f3193d07d7c8a98136dbaff74/bin/jar
          test -f ~/.tipi/nodejs/4472af28a2bd943fe64f4dfb9d44c5ebde152ec0/bin/node
          test -f ~/.tipi/openapi/ec7cbaed034d7aaeb2a0f22619a8927c08a74894/openapi-generator-cli-5.1.1.jar
          test -f ~/.tipi/openapi-generator-script/4fc850d4a145be49a9aa0428dcbc5c5c82f19f93/openapi-generator-cli
          test -f ~/.tipi/file-sync/9b0a5c87058b68cd466a3cc8e8cfd7d9cbd89df2/pysearpc/client.py
          test -f ~/.tipi/platform/2a344bab73de81f19feca4fa3d724e1d9607d55e/cmake/projects/Poco/hunter.cmake

